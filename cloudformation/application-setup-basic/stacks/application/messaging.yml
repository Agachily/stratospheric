AWSTemplateFormatVersion: '2010-09-09'
Description: A stack that creates messaging infrastructure
Parameters:
  TodoSharingQueueName:
    Type: String
    Description: The name of the queue to share todos
  TodoUpdatesTopicName:
    Type: String
    Description: The name of the topic to share todos updates
Resources:
  TodoSharingQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Ref TodoSharingQueueName
      MessageRetentionPeriod: 1209600 # 14 days maximum
      VisibilityTimeout: 300 # 5 minutes
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt 'TodoSharingDeadLetterQueue.Arn'
        maxReceiveCount: 3

  TodoSharingDeadLetterQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName:  !Join [ '-', [ !Ref 'TodoSharingQueueName', 'dead-letter-queue' ] ]
      MessageRetentionPeriod: 1209600 # 14 days maximum
  TodoUpdates:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: !Ref TodoUpdatesTopicName

Outputs:
  TodoSharingQueueArn:
    Description: Arn of the TodoSharing Queue of the RDS endpoint.
    Value: !GetAtt 'TodoSharingQueue.Arn'
    Export:
      Name: !Join [ ':', [ !Ref 'AWS::StackName', 'TodoSharingQueueArn' ] ]
  StackName:
    Description: The name of this stack
    Value: !Ref 'AWS::StackName'
  TodoUpdatesARN:
    Value: !Ref TodoUpdates
